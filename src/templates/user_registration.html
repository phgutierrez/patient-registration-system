{% extends "base.html" %}

{% block content %}
<div class="container" style="max-width: 1000px; margin: 0 auto;">
    <!-- Cabeçalho da Página -->
    <div class="card border-0 shadow-sm mb-4" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
        <div class="card-body py-4">
            <h1 class="mb-2" style="font-size: 2rem; font-weight: 700;">
                <i class="fas fa-user-cog me-3"></i>Gerenciar Solicitantes
            </h1>
            <p class="mb-0" style="font-size: 1rem; opacity: 0.95;">
                Adicione e gerencie os médicos que podem solicitar cirurgias no sistema
            </p>
        </div>
    </div>
    
    <!-- Formulário para adicionar novo usuário -->
    <div class="card mb-4 border-0 shadow-sm">
        <div class="card-header" style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); color: white; border: none;">
            <h5 class="card-title mb-0">
                <i class="fas fa-plus-circle me-2"></i>Adicionar Novo Solicitante
            </h5>
        </div>
        <div class="card-body p-4">
            <form method="POST" action="{{ url_for('auth.register_user') }}">
                <input type="hidden" name="action" value="add_user">
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="full_name" class="form-label" style="font-weight: 600;">Nome Completo *</label>
                        <div class="input-group">
                            <span class="input-group-text" style="background-color: #f1f5f9; border: 2px solid #e2e8f0; color: #3b82f6;">
                                <i class="fas fa-user"></i>
                            </span>
                            <input type="text" id="full_name" name="full_name" required class="form-control" style="border: 2px solid #e2e8f0; border-left: none; padding: 0.75rem;" placeholder="Nome completo do médico">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label for="cns" class="form-label" style="font-weight: 600;">CNS</label>
                        <div class="input-group">
                            <span class="input-group-text" style="background-color: #f1f5f9; border: 2px solid #e2e8f0; color: #3b82f6;">
                                <i class="fas fa-id-card"></i>
                            </span>
                            <input type="text" id="cns" name="cns" class="form-control" style="border: 2px solid #e2e8f0; border-left: none; padding: 0.75rem;" placeholder="Cartão Nacional de Saúde">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label for="crm" class="form-label" style="font-weight: 600;">CRM</label>
                        <div class="input-group">
                            <span class="input-group-text" style="background-color: #f1f5f9; border: 2px solid #e2e8f0; color: #3b82f6;">
                                <i class="fas fa-user-md"></i>
                            </span>
                            <input type="text" id="crm" name="crm" class="form-control" style="border: 2px solid #e2e8f0; border-left: none; padding: 0.75rem;" placeholder="Registro profissional">
                        </div>
                    </div>
                </div>
                
                <div class="d-flex justify-content-end mt-4">
                    <button type="submit" class="btn btn-lg" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 0.75rem 2rem; border-radius: 8px; font-weight: 600; border: none;">
                        <i class="fas fa-plus-circle me-2"></i>Adicionar Solicitante
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Tabela de usuários existentes -->
    <div class="card border-0 shadow-sm">
        <div class="card-header" style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); color: white; border: none;">
            <h5 class="card-title mb-0">
                <i class="fas fa-users me-2"></i>Solicitantes Registrados
                <span class="badge bg-light text-dark ms-2">{{ users|length if users else 0 }}</span>
            </h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0" style="border: none;">
                    <thead style="background: linear-gradient(135deg, #334155 0%, #1e293b 100%); color: white;">
                        <tr>
                            <th style="padding: 1rem; border: none;"><i class="fas fa-user me-2"></i>Nome Completo</th>
                            <th style="padding: 1rem; border: none;"><i class="fas fa-id-card me-2"></i>CNS</th>
                            <th style="padding: 1rem; border: none;"><i class="fas fa-user-md me-2"></i>CRM</th>
                            <th style="padding: 1rem; text-align: center; border: none;"><i class="fas fa-cog me-2"></i>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                {% if users %}
                    {% for user in users %}
                        <tr style="border-bottom: 1px solid #dee2e6;" id="user-row-{{ user.id }}">
                            <td style="padding: 12px; border: 1px solid #dee2e6;">
                                <span class="user-name-{{ user.id }}">{{ user.full_name }}</span>
                                <input type="text" id="edit-full_name-{{ user.id }}" value="{{ user.full_name }}" style="display: none; width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px;">
                            </td>
                            <td style="padding: 12px; border: 1px solid #dee2e6;">
                                <span class="user-cns-{{ user.id }}">{{ user.cns or '-' }}</span>
                                <input type="text" id="edit-cns-{{ user.id }}" value="{{ user.cns or '' }}" style="display: none; width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px;">
                            </td>
                            <td style="padding: 12px; border: 1px solid #dee2e6;">
                                <span class="user-crm-{{ user.id }}">{{ user.crm or '-' }}</span>
                                <input type="text" id="edit-crm-{{ user.id }}" value="{{ user.crm or '' }}" style="display: none; width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px;">
                            </td>
                            <td style="padding: 12px; text-align: center; border: 1px solid #dee2e6;">
                                <div style="display: flex; gap: 5px; flex-wrap: wrap; justify-content: center;">
                                    <button type="button" class="btn btn-edit" onclick="toggleEditMode({{ user.id }})" id="edit-btn-{{ user.id }}" style="padding: 5px 10px; background-color: #ffc107; color: black; border: none; border-radius: 4px; cursor: pointer;">
                                        <span class="edit-btn-text-{{ user.id }}">Editar</span>
                                        <span class="edit-btn-text-cancel-{{ user.id }}" style="display: none;">Cancelar</span>
                                    </button>
                                    <button type="button" class="btn btn-save" id="save-btn-{{ user.id }}" style="display: none; padding: 5px 10px; background-color: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer;" onclick="saveUser({{ user.id }})">
                                        Salvar
                                    </button>
                                    <form method="POST" action="{{ url_for('auth.register_user') }}" style="display: inline;">
                                        <input type="hidden" name="action" value="delete_user">
                                        <input type="hidden" name="user_id" value="{{ user.id }}">
                                        <button type="submit" class="btn btn-danger" id="delete-btn-{{ user.id }}" style="padding: 5px 10px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;" onclick="return confirm('Tem certeza que deseja deletar este usuário?');">
                                            Deletar
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="4" style="padding: 12px; text-align: center; color: #6c757d;">
                            Nenhum solicitante registrado
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
    
    <div style="margin-top: 20px;">
        <a href="{{ url_for('auth.select_user') }}" class="btn btn-secondary" style="padding: 10px 20px; background-color: #6c757d; color: white; border: none; border-radius: 4px; text-decoration: none; cursor: pointer;">
            Voltar para Seleção
        </a>
    </div>
</div>

<script>
function toggleEditMode(userId) {
    const nameSpan = document.querySelector('.user-name-' + userId);
    const nameInput = document.getElementById('edit-full_name-' + userId);
    const cnsSpan = document.querySelector('.user-cns-' + userId);
    const cnsInput = document.getElementById('edit-cns-' + userId);
    const crmSpan = document.querySelector('.user-crm-' + userId);
    const crmInput = document.getElementById('edit-crm-' + userId);
    const editBtn = document.querySelector('[onclick="toggleEditMode(' + userId + ')"]');
    const saveBtn = document.getElementById('save-btn-' + userId);
    const editBtnText = document.querySelector('.edit-btn-text-' + userId);
    const editBtnCancel = document.querySelector('.edit-btn-text-cancel-' + userId);
    
    // Toggle display
    if (nameInput.style.display === 'none') {
        // Entrar em modo edição
        nameSpan.style.display = 'none';
        nameInput.style.display = 'block';
        cnsSpan.style.display = 'none';
        cnsInput.style.display = 'block';
        crmSpan.style.display = 'none';
        crmInput.style.display = 'block';
        saveBtn.style.display = 'inline-block';
        editBtnText.style.display = 'none';
        editBtnCancel.style.display = 'inline';
    } else {
        // Sair do modo edição
        nameSpan.style.display = 'inline';
        nameInput.style.display = 'none';
        cnsSpan.style.display = 'inline';
        cnsInput.style.display = 'none';
        crmSpan.style.display = 'inline';
        crmInput.style.display = 'none';
        saveBtn.style.display = 'none';
        editBtnText.style.display = 'inline';
        editBtnCancel.style.display = 'none';
    }
}

function saveUser(userId) {
    const fullName = document.getElementById('edit-full_name-' + userId).value;
    const cns = document.getElementById('edit-cns-' + userId).value;
    const crm = document.getElementById('edit-crm-' + userId).value;
    
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{ url_for("auth.register_user") }}';
    
    const actionInput = document.createElement('input');
    actionInput.type = 'hidden';
    actionInput.name = 'action';
    actionInput.value = 'edit_user';
    
    const userIdInput = document.createElement('input');
    userIdInput.type = 'hidden';
    userIdInput.name = 'user_id';
    userIdInput.value = userId;
    
    const fullNameInput = document.createElement('input');
    fullNameInput.type = 'hidden';
    fullNameInput.name = 'full_name';
    fullNameInput.value = fullName;
    
    const cnsInput = document.createElement('input');
    cnsInput.type = 'hidden';
    cnsInput.name = 'cns';
    cnsInput.value = cns;
    
    const crmInput = document.createElement('input');
    crmInput.type = 'hidden';
    crmInput.name = 'crm';
    crmInput.value = crm;
    
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrf_token';
    csrfInput.value = '{{ csrf_token() }}';
    
    form.appendChild(actionInput);
    form.appendChild(userIdInput);
    form.appendChild(fullNameInput);
    form.appendChild(cnsInput);
    form.appendChild(crmInput);
    form.appendChild(csrfInput);
    
    document.body.appendChild(form);
    form.submit();
}
</script>
{% endblock %}