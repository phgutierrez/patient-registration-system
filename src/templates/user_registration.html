{% extends "base.html" %}

{% block content %}
<div class="user-management-container" style="max-width: 900px; margin: 30px auto; padding: 20px;">
    <h1>Gerenciar Solicitantes</h1>
    
    <!-- Formulário para adicionar novo usuário -->
    <div style="background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
        <h2>Adicionar Novo Solicitante</h2>
        <form method="POST" action="{{ url_for('auth.register_user') }}">
            <input type="hidden" name="action" value="add_user">
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div class="form-group">
                    <label for="full_name">Nome Completo:</label>
                    <input type="text" id="full_name" name="full_name" required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div class="form-group">
                    <label for="cns">CNS:</label>
                    <input type="text" id="cns" name="cns" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div class="form-group">
                    <label for="crm">CRM:</label>
                    <input type="text" id="crm" name="crm" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary" style="padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                Adicionar Solicitante
            </button>
        </form>
    </div>
    
    <!-- Tabela de usuários existentes -->
    <div>
        <h2>Solicitantes Registrados</h2>
        <table style="width: 100%; border-collapse: collapse; background-color: white;">
            <thead>
                <tr style="background-color: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                    <th style="padding: 12px; text-align: left; border: 1px solid #dee2e6;">Nome Completo</th>
                    <th style="padding: 12px; text-align: left; border: 1px solid #dee2e6;">CNS</th>
                    <th style="padding: 12px; text-align: left; border: 1px solid #dee2e6;">CRM</th>
                    <th style="padding: 12px; text-align: center; border: 1px solid #dee2e6;">Ações</th>
                </tr>
            </thead>
            <tbody>
                {% if users %}
                    {% for user in users %}
                        <tr style="border-bottom: 1px solid #dee2e6;" id="user-row-{{ user.id }}">
                            <td style="padding: 12px; border: 1px solid #dee2e6;">
                                <span class="user-name-{{ user.id }}">{{ user.full_name }}</span>
                                <input type="text" id="edit-full_name-{{ user.id }}" value="{{ user.full_name }}" style="display: none; width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px;">
                            </td>
                            <td style="padding: 12px; border: 1px solid #dee2e6;">
                                <span class="user-cns-{{ user.id }}">{{ user.cns or '-' }}</span>
                                <input type="text" id="edit-cns-{{ user.id }}" value="{{ user.cns or '' }}" style="display: none; width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px;">
                            </td>
                            <td style="padding: 12px; border: 1px solid #dee2e6;">
                                <span class="user-crm-{{ user.id }}">{{ user.crm or '-' }}</span>
                                <input type="text" id="edit-crm-{{ user.id }}" value="{{ user.crm or '' }}" style="display: none; width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px;">
                            </td>
                            <td style="padding: 12px; text-align: center; border: 1px solid #dee2e6;">
                                <div style="display: flex; gap: 5px; flex-wrap: wrap; justify-content: center;">
                                    <button type="button" class="btn btn-edit" onclick="toggleEditMode({{ user.id }})" id="edit-btn-{{ user.id }}" style="padding: 5px 10px; background-color: #ffc107; color: black; border: none; border-radius: 4px; cursor: pointer;">
                                        <span class="edit-btn-text-{{ user.id }}">Editar</span>
                                        <span class="edit-btn-text-cancel-{{ user.id }}" style="display: none;">Cancelar</span>
                                    </button>
                                    <button type="button" class="btn btn-save" id="save-btn-{{ user.id }}" style="display: none; padding: 5px 10px; background-color: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer;" onclick="saveUser({{ user.id }})">
                                        Salvar
                                    </button>
                                    <form method="POST" action="{{ url_for('auth.register_user') }}" style="display: inline;">
                                        <input type="hidden" name="action" value="delete_user">
                                        <input type="hidden" name="user_id" value="{{ user.id }}">
                                        <button type="submit" class="btn btn-danger" id="delete-btn-{{ user.id }}" style="padding: 5px 10px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;" onclick="return confirm('Tem certeza que deseja deletar este usuário?');">
                                            Deletar
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="4" style="padding: 12px; text-align: center; color: #6c757d;">
                            Nenhum solicitante registrado
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
    
    <div style="margin-top: 20px;">
        <a href="{{ url_for('auth.select_user') }}" class="btn btn-secondary" style="padding: 10px 20px; background-color: #6c757d; color: white; border: none; border-radius: 4px; text-decoration: none; cursor: pointer;">
            Voltar para Seleção
        </a>
    </div>
</div>

<script>
function toggleEditMode(userId) {
    const nameSpan = document.querySelector('.user-name-' + userId);
    const nameInput = document.getElementById('edit-full_name-' + userId);
    const cnsSpan = document.querySelector('.user-cns-' + userId);
    const cnsInput = document.getElementById('edit-cns-' + userId);
    const crmSpan = document.querySelector('.user-crm-' + userId);
    const crmInput = document.getElementById('edit-crm-' + userId);
    const editBtn = document.querySelector('[onclick="toggleEditMode(' + userId + ')"]');
    const saveBtn = document.getElementById('save-btn-' + userId);
    const editBtnText = document.querySelector('.edit-btn-text-' + userId);
    const editBtnCancel = document.querySelector('.edit-btn-text-cancel-' + userId);
    
    // Toggle display
    if (nameInput.style.display === 'none') {
        // Entrar em modo edição
        nameSpan.style.display = 'none';
        nameInput.style.display = 'block';
        cnsSpan.style.display = 'none';
        cnsInput.style.display = 'block';
        crmSpan.style.display = 'none';
        crmInput.style.display = 'block';
        saveBtn.style.display = 'inline-block';
        editBtnText.style.display = 'none';
        editBtnCancel.style.display = 'inline';
    } else {
        // Sair do modo edição
        nameSpan.style.display = 'inline';
        nameInput.style.display = 'none';
        cnsSpan.style.display = 'inline';
        cnsInput.style.display = 'none';
        crmSpan.style.display = 'inline';
        crmInput.style.display = 'none';
        saveBtn.style.display = 'none';
        editBtnText.style.display = 'inline';
        editBtnCancel.style.display = 'none';
    }
}

function saveUser(userId) {
    const fullName = document.getElementById('edit-full_name-' + userId).value;
    const cns = document.getElementById('edit-cns-' + userId).value;
    const crm = document.getElementById('edit-crm-' + userId).value;
    
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{ url_for("auth.register_user") }}';
    
    const actionInput = document.createElement('input');
    actionInput.type = 'hidden';
    actionInput.name = 'action';
    actionInput.value = 'edit_user';
    
    const userIdInput = document.createElement('input');
    userIdInput.type = 'hidden';
    userIdInput.name = 'user_id';
    userIdInput.value = userId;
    
    const fullNameInput = document.createElement('input');
    fullNameInput.type = 'hidden';
    fullNameInput.name = 'full_name';
    fullNameInput.value = fullName;
    
    const cnsInput = document.createElement('input');
    cnsInput.type = 'hidden';
    cnsInput.name = 'cns';
    cnsInput.value = cns;
    
    const crmInput = document.createElement('input');
    crmInput.type = 'hidden';
    crmInput.name = 'crm';
    crmInput.value = crm;
    
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrf_token';
    csrfInput.value = '{{ csrf_token() }}';
    
    form.appendChild(actionInput);
    form.appendChild(userIdInput);
    form.appendChild(fullNameInput);
    form.appendChild(cnsInput);
    form.appendChild(crmInput);
    form.appendChild(csrfInput);
    
    document.body.appendChild(form);
    form.submit();
}
</script>
{% endblock %}