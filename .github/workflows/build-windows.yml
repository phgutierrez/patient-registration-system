name: Build Windows Executables

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version'
        required: true
        default: 'v1.0.1'
  push:
    branches:
      - 'teste-exe'
    tags:
      - 'v*'

jobs:
  build:
    runs-on: windows-latest
    
    strategy:
      matrix:
        python-version: ['3.11']
        arch: ['x64', 'x86']
        include:
          - arch: 'x64'
            spec-file: 'prontuario_64bits.spec'
            output-name: 'prontuario-64bits'
          - arch: 'x86'
            spec-file: 'prontuario_32bits.spec'
            output-name: 'prontuario-32bits'

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        architecture: ${{ matrix.arch }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Build executable
      run: |
        pyinstaller --clean ${{ matrix.spec-file }}
    
    - name: Create ZIP archive
      shell: powershell
      run: |
        # Extrair versão de forma segura
        $ref = "${{ github.ref }}"
        $version = $ref -replace '^refs/tags/', ''
        $version = $version -replace '^refs/heads/', ''
        
        # Valor padrão se vazio
        if ([string]::IsNullOrEmpty($version) -or $version -eq $ref) {
          $version = 'v1.0.1'
        }
        
        # Nome do arquivo ZIP
        $zipName = "prontuario-$version-${{ matrix.arch }}-bits.zip"
        
        Write-Host "Versão: $version"
        Write-Host "ZIP Name: $zipName"
        
        if (Test-Path "dist\${{ matrix.output-name }}") {
          Compress-Archive -Path "dist\${{ matrix.output-name }}" -DestinationPath $zipName -Force
          Write-Host "ZIP criado com sucesso: $zipName"
          Write-Host "Tamanho: $((Get-Item $zipName).Length / 1MB) MB"
        } else {
          Write-Error "Diretório de build não encontrado: dist\${{ matrix.output-name }}"
          exit 1
        }
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: prontuario-${{ matrix.arch }}-bits
        path: prontuario-v*.zip
        retention-days: 30
    
    - name: Create Release Assets
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: prontuario-*.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
