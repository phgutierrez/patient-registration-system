name: Build Windows Executables

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version'
        required: true
        default: 'v1.0.1'
  push:
    branches:
      - 'teste-exe'
    tags:
      - 'v*'

jobs:
  build:
    runs-on: windows-latest
    
    strategy:
      matrix:
        python-version: ['3.11']
        arch: ['x64', 'x86']
        include:
          - arch: 'x64'
            spec-file: 'prontuario_64bits.spec'
            output-name: 'prontuario-64bits'
          - arch: 'x86'
            spec-file: 'prontuario_32bits.spec'
            output-name: 'prontuario-32bits'

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        architecture: ${{ matrix.arch }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Build executable
      run: |
        pyinstaller --clean ${{ matrix.spec-file }}
    
    - name: Create ZIP archive
      shell: powershell
      run: |
        # Extrair versão com lógica clara
        $ref = "${{ github.ref }}"
        $version = $null
        
        # Se for tag (refs/tags/v1.0.1)
        if ($ref -match '^refs/tags/') {
          $version = $ref -replace '^refs/tags/', ''
        }
        # Se for branch (refs/heads/teste-exe)
        elseif ($ref -match '^refs/heads/') {
          $version = $ref -replace '^refs/heads/', ''
        }
        # Se for workflow_dispatch, usar input ou default
        else {
          $version = '${{ github.event.inputs.version }}'
        }
        
        # Usar default se ainda estiver vazio
        if ([string]::IsNullOrEmpty($version)) {
          $version = 'v1.0.1'
        }
        
        Write-Host "GitHub Ref: $ref"
        Write-Host "Versão detectada: $version"
        
        # Nome do arquivo ZIP
        $zipName = "prontuario-$version-${{ matrix.arch }}-bits.zip"
        $destPath = "dist\$zipName"
        
        Write-Host "ZIP Name: $zipName"
        Write-Host "Dest Path: $destPath"
        
        if (Test-Path "dist\${{ matrix.output-name }}") {
          Write-Host "Build dir encontrado: dist\${{ matrix.output-name }}"
          Compress-Archive -Path "dist\${{ matrix.output-name }}" -DestinationPath $destPath -Force
          
          if (Test-Path $destPath) {
            $size = (Get-Item $destPath).Length / 1MB
            Write-Host "✓ ZIP criado com sucesso: $zipName ($([Math]::Round($size, 2)) MB)"
          } else {
            Write-Error "Falha ao criar ZIP"
            exit 1
          }
        } else {
          Write-Error "Diretório de build não encontrado: dist\${{ matrix.output-name }}"
          Get-ChildItem dist -ErrorAction SilentlyContinue | Select-Object FullName
          exit 1
        }
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: prontuario-${{ matrix.arch }}-bits
        path: prontuario-v*.zip
        retention-days: 30
    
    - name: Create Release Assets
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: prontuario-*.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
