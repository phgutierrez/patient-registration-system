name: Build Windows Executables

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version'
        required: true
        default: 'v1.0.1'
  push:
    branches:
      - 'teste-exe'
    tags:
      - 'v*'

jobs:
  build:
    runs-on: windows-latest
    
    strategy:
      matrix:
        python-version: ['3.11']
        arch: ['x64', 'x86']
        include:
          - arch: 'x64'
            spec-file: 'prontuario_64bits.spec'
            output-name: 'prontuario-64bits'
          - arch: 'x86'
            spec-file: 'prontuario_32bits.spec'
            output-name: 'prontuario-32bits'

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        architecture: ${{ matrix.arch }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Build executable
      run: |
        pyinstaller --clean ${{ matrix.spec-file }}
    
    - name: Create ZIP archive
      shell: powershell
      run: |
        # Extract version info
        $ref = "${{ github.ref }}"
        $version = $null
        
        if ($ref -match 'refs/tags') {
          $version = $ref -replace 'refs/tags/', ''
        }
        elseif ($ref -match 'refs/heads') {
          $version = $ref -replace 'refs/heads/', ''
        }
        else {
          $version = '${{ github.event.inputs.version }}'
        }
        
        if ([string]::IsNullOrEmpty($version)) {
          $version = 'v1.0.1'
        }
        
        Write-Host "Ref: $ref"
        Write-Host "Version: $version"
        
        $zipName = "prontuario-$version-${{ matrix.arch }}-bits.zip"
        $srcPath = "dist\${{ matrix.output-name }}"
        
        Write-Host "Source: $srcPath"
        Write-Host "Dest: $zipName"
        
        if (Test-Path $srcPath) {
          Write-Host "Found: $srcPath"
          Compress-Archive -Path $srcPath -DestinationPath $zipName -Force
          Write-Host "ZIP created: $zipName"
        } else {
          Write-Host "ERROR: Path not found: $srcPath"
          exit 1
        }
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: prontuario-${{ matrix.arch }}-bits
        path: prontuario-v*.zip
        retention-days: 30
    
    - name: Create Release Assets
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: prontuario-*.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
